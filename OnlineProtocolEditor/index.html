<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Protocol Editor</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="app-header">
      <h1>Pocket Lab App - Online Protocol Editor</h1>
      <p class="tagline">Edit and validate PoLA protocol files in your browser.</p>
    </header>

    <main class="app-layout">
      <section class="editor-panel">
        <div class="toolbar" role="toolbar" aria-label="Protocol actions">
          <button id="newButton" class="primary" type="button">New</button>
          <button id="loadButton" type="button">Load…</button>
          <button id="saveButton" type="button">Save</button>
          <button id="downloadButton" type="button">Download</button>
          <button id="templatesButton" type="button">Templates</button>
          <div role="separator" class="toolbar-divider" aria-hidden="true"></div>
          <button id="aboutButton" type="button" class="link-button">About</button>
          <button id="manualButton" type="button" class="link-button">Manual</button>
          <div class="toolbar-spacer"></div>
          <label class="checkbox" for="autoValidate">
            <input id="autoValidate" type="checkbox" checked />
            Auto validate
          </label>
        </div>
        <div id="commandSuggestion" class="suggestion-bar" role="status" aria-live="polite"></div>
        <div class="inline-action-row">
          <button id="insertButton" type="button" class="primary">Insert Command</button>
        </div>
        <div class="protocol-input-wrapper">
          <pre id="protocolGhost" class="protocol-ghost" aria-hidden="true"><span class="ghost-prefix"></span><span class="ghost-suggestion"></span></pre>
          <textarea
            id="protocolInput"
            aria-label="Protocol contents"
            spellcheck="false"
            placeholder="Insert a command using the button above, or start typing your protocol here…"
          ></textarea>
        </div>
        <footer class="editor-footer">
          <span id="lineCount" aria-live="polite">0 lines</span>
          <span id="statusText" aria-live="polite"></span>
          <span id="unsavedIndicator" class="status-pill warning" hidden>Unsaved changes</span>
        </footer>
      </section>

      <aside class="inspector-panel">
        <section class="card" id="validationCard">
          <header class="card-header">
            <h2>Validation</h2>
            <div class="card-actions">
              <button id="validateButton" type="button">Validate now</button>
            </div>
          </header>
          <div class="validation-controls">
            <input
              id="issueFilter"
              type="search"
              placeholder="Filter by text or line number"
              aria-label="Filter validation results"
            />
            <div class="issue-nav">
              <button id="prevIssue" type="button" aria-label="Previous issue">◀</button>
              <button id="nextIssue" type="button" aria-label="Next issue">▶</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table id="validationTable">
              <thead>
                <tr>
                  <th scope="col">Line</th>
                  <th scope="col">Command</th>
                  <th scope="col">Error</th>
                  <th scope="col">Warning</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card" id="commandsCard">
          <header class="card-header">
            <h2>Recognized commands</h2>
            <button id="toggleCommands" type="button" aria-expanded="false">Show all</button>
          </header>
          <div class="card-body" id="commandsBody" hidden>
            <p class="card-hint">Commands are case-insensitive. Tap any command to insert a template.</p>
            <div id="commandList" class="command-groups"></div>
          </div>
        </section>

        <section class="card" id="cheatsheetCard">
          <header class="card-header">
            <h2>Cheat sheet</h2>
          </header>
          <div class="card-body">
            <ul class="cheat-list">
              <li><strong>//</strong> starts a comment; comments are ignored when validating.</li>
              <li>Use semicolons to separate command segments.</li>
              <li>Use <code>LABEL;Name</code> + <code>GOTO;Name</code> for branching.</li>
              <li>
                Wrap optional values in brackets, e.g. <code>[Continue]</code> or <code>[Hold]</code>.
              </li>
              <li>
                Randomization uses balanced pairs of <code>RANDOMIZE_ON</code> and <code>RANDOMIZE_OFF</code>.
              </li>
            </ul>
          </div>
        </section>
      </aside>
    </main>

    <input id="fileInput" type="file" accept=".txt,text/plain" hidden />

    <dialog id="insertDialog">
      <form method="dialog" class="insert-form" novalidate>
        <header class="dialog-header">
          <h2 id="insertDialogTitle">Insert command</h2>
          <p id="insertDialogSubtitle" class="dialog-subtitle">
            Pick a command on the left, then configure its parameters before inserting it into the protocol.
          </p>
        </header>
        <div class="dialog-columns">
          <section class="command-picker" aria-label="Command list">
            <div class="picker-controls">
              <label class="field">
                Category
                <select id="insertCategory"></select>
              </label>
              <label class="field">
                Search
                <input id="insertSearch" type="search" placeholder="Search commands" />
              </label>
            </div>
            <ul id="insertCommandList" class="command-list" role="listbox"></ul>
          </section>
          <section class="command-config" aria-live="polite">
            <div class="config-header">
              <div>
                <p class="config-label">Selected command</p>
                <h3 id="selectedCommandName">None</h3>
              </div>
              <button id="clearCommandSelection" type="button" class="link-button" hidden>Clear</button>
            </div>
            <div id="configContent" class="config-content">
              <p id="configPlaceholder" class="config-placeholder">
                Choose a command to see its parameters and validation helpers.
              </p>
              <div id="configSections" hidden>
                <div id="commandHint" class="command-hint" aria-live="polite"></div>
                <div id="parameterContainer" class="parameter-container"></div>
              </div>
              <p id="insertDialogMessage" class="dialog-message" role="alert" hidden></p>
            </div>
          </section>
        </div>
        <footer class="dialog-footer">
          <button id="insertDialogCancel" value="cancel" type="button">Cancel</button>
          <div class="dialog-footer-gap"></div>
          <button id="insertDialogSubmit" value="confirm" type="submit" class="primary">Insert</button>
        </footer>
      </form>
    </dialog>

    <dialog id="templatesDialog">
      <form method="dialog" class="templates-form" novalidate>
        <header class="dialog-header">
          <h2 id="templatesDialogTitle">Protocol templates</h2>
          <p id="templatesDialogSubtitle" class="dialog-subtitle">
            Browse ready-to-run study examples. Pick one to insert into your protocol.
          </p>
        </header>
        <div class="dialog-columns templates-columns">
          <section class="command-picker" aria-label="Template list">
            <div class="picker-controls templates-controls">
              <label class="field">
                Search
                <input id="templatesSearch" type="search" placeholder="Search templates" />
              </label>
              <div class="tag-filter-row" role="group" aria-label="Filter templates by tags">
                <span class="tag-filter-label">Tags</span>
                <div
                  id="templatesTagList"
                  class="tag-chip-list"
                  role="listbox"
                  aria-label="Template tags"
                  aria-multiselectable="true"
                ></div>
                <button id="clearTemplateTags" type="button" class="link-button" hidden>Clear</button>
              </div>
              <button
                id="templatesFavoritesToggle"
                type="button"
                class="favorites-toggle"
                aria-pressed="false"
                aria-label="Show only favorited templates"
              >
                <span class="favorites-toggle-icon" aria-hidden="true">☆</span>
                Favorites only
              </button>
            </div>
            <ul id="templatesList" class="command-list" role="listbox"></ul>
          </section>
          <section class="command-config templates-config" aria-live="polite">
            <div class="config-header">
              <div>
                <p class="config-label">Selected template</p>
                <h3 id="selectedTemplateName">None</h3>
              </div>
              <button id="clearTemplateSelection" type="button" class="link-button" hidden>Clear</button>
            </div>
            <div id="templatesContent" class="config-content">
              <p id="templatesPlaceholder" class="config-placeholder">
                Choose a template to see the study outline and instructions.
              </p>
              <div id="templateDetail" hidden>
                <div id="templateSummary" class="command-hint" aria-live="polite"></div>
                <pre id="templatePreview" class="template-preview" aria-label="Template preview"></pre>
              </div>
              <p id="templatesDialogMessage" class="dialog-message" role="alert" hidden></p>
            </div>
          </section>
        </div>
        <footer class="dialog-footer">
          <button id="templatesDialogCancel" value="cancel" type="button">Cancel</button>
          <div class="dialog-footer-gap"></div>
          <button id="insertTemplateButton" value="confirm" type="submit" class="primary" disabled>Insert template</button>
        </footer>
      </form>
    </dialog>

    <dialog id="aboutDialog" class="content-dialog" aria-labelledby="aboutDialogTitle">
      <article class="content-surface">
        <header class="content-dialog-header">
          <div>
            <h2 id="aboutDialogTitle">About the Online Protocol Editor</h2>
            <p class="content-dialog-subtitle">Craft PoLA study scripts directly in your browser.</p>
          </div>
          <button id="aboutDialogClose" type="button" class="link-button">Close</button>
        </header>
        <div class="content-body about-content" tabindex="0">
          <div id="aboutContent" class="markdown-view" data-source="./content/about.md" role="document">
            <p class="loading-placeholder">Loading documentation…</p>
          </div>
        </div>
      </article>
    </dialog>

    <dialog id="manualDialog" class="content-dialog" aria-labelledby="manualDialogTitle">
      <article class="content-surface">
        <header class="content-dialog-header">
          <div>
            <h2 id="manualDialogTitle">Online Protocol Editor Manual</h2>
            <p class="content-dialog-subtitle">Author studies for PoLA and deploy them to Android devices.</p>
          </div>
          <button id="manualDialogClose" type="button" class="link-button">Close</button>
        </header>
        <div class="content-body manual-content" tabindex="0">
          <div id="manualContent" class="markdown-view" data-source="./content/manual.md" role="document">
            <p class="loading-placeholder">Loading documentation…</p>
          </div>
        </div>
      </article>
    </dialog>

    <dialog id="welcomeDialog" class="content-dialog" aria-labelledby="welcomeDialogTitle">
      <article class="content-surface">
        <header class="content-dialog-header">
          <div>
            <h2 id="welcomeDialogTitle">Welcome to the Online Protocol Editor!</h2>
            <p class="content-dialog-subtitle">Create and edit PoLA research protocols in your browser.</p>
          </div>
        </header>
        <div class="content-body" style="padding: 24px;">
          <div style="line-height: 1.6; color: var(--text);">
            <p><strong>What is this editor?</strong></p>
            <p>This online tool allows you to create and edit research protocol files (.txt) for the <strong>Pocket Lab App</strong>.</p>
            
            <p><strong>How to use your protocols:</strong></p>
            <ol style="margin-left: 20px; line-height: 1.6;">
              <li><strong>Create</strong> your protocol using this editor</li>
              <li><strong>Download</strong> the .txt file to your computer</li>
              <li><strong>Transfer</strong> the file to your smartphone via:
                <ul style="margin-left: 20px; margin-top: 8px;">
                  <li>USB cable</li>
                  <li>Cloud storage (Google Drive, Dropbox, OneDrive, etc.)</li>
                  <li>Email attachment</li>
                </ul>
              </li>
              <li><strong>Open</strong> the protocol file in the Pocket Lab App on your smartphone</li>
            </ol>
            
            <p style="margin-top: 16px;"><strong>Making adjustments:</strong></p>
            <p>Minor edits can be made directly on your smartphone using the built-in <strong>Protocol Manager</strong>, but this online editor provides a better experience for creating and editing full protocols.</p>
            
            <div style="margin-top: 20px; padding: 12px 16px; border-left: 3px solid var(--danger); background: var(--danger-soft); border-radius: 4px;">
              <p style="margin: 0; color: var(--danger); font-weight: 600; font-size: 0.9rem;">
                <strong>Important:</strong> Protocols created here must be transferred to your smartphone and launched in the Pocket Lab App.
              </p>
            </div>
            
            <p style="margin-top: 16px;"><em>For detailed instructions and command reference, see the <strong>Manual</strong> above.</em></p>
          </div>
        </div>
        <footer class="dialog-footer">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-right: auto;">
            <input type="checkbox" id="welcomeDialogDontShow" style="cursor: pointer;">
            <span>Don't show this message again</span>
          </label>
          <button id="welcomeDialogClose" type="button" class="primary">Got it!</button>
        </footer>
      </article>
    </dialog>

    <script defer src="vendor/marked.js"></script>
    <script defer src="main.js"></script>
  </body>
</html>
